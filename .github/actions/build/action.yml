name: Build
description: Runs local tests, builds APKs, and uploads build artifacts.
inputs:
  gradle-cache-encryption-key:
    description: Gradle cache encryption key used by setup-gradle.
    required: false
runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Copy CI gradle.properties
      run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: 21

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-encryption-key: ${{ inputs.gradle-cache-encryption-key }}
        build-scan-publish: true
        build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
        build-scan-terms-of-use-agree: "yes"

    - name: Processs Watcher 
      uses: cdsap/build-process-watcher@v0.5.0
      with:
         remote_monitoring: true

    - name: Check build-logic
      run: ./gradlew :build-logic:convention:check
      shell: bash

    - name: Processs Watcher 
      uses: cdsap/build-process-watcher@v0.5.0
      with:
         remote_monitoring: true

    - name: Check spotless
      run: ./gradlew spotlessCheck
      shell: bash

    - name: Check Dependency Guard
      id: dependencyguard_verify
      continue-on-error: true
      run: ./gradlew dependencyGuard
      shell: bash

    - name: Prevent updating Dependency Guard baselines if this is a fork
      id: checkfork_dependencyguard
      continue-on-error: false
      if: steps.dependencyguard_verify.outcome == 'failure' && github.event.pull_request.head.repo.full_name != github.repository
      run: |
        echo "::error::Dependency Guard failed, please update baselines with: ./gradlew dependencyGuardBaseline" && exit 1
      shell: bash

      # Runs if previous job failed
    - name: Generate new Dependency Guard baselines if verification failed and it's a PR
      id: dependencyguard_baseline
      if: steps.dependencyguard_verify.outcome == 'failure' && github.event_name == 'pull_request'
      run: |
        ./gradlew dependencyGuardBaseline
      shell: bash

    - name: Push new Dependency Guard baselines if available
      uses: stefanzweifel/git-auto-commit-action@v5
      if: steps.dependencyguard_baseline.outcome == 'success'
      with:
        file_pattern: '**/dependencies/*.txt'
        disable_globbing: true
        commit_message: "ðŸ¤– Updates baselines for Dependency Guard"

    - name: Update Graphs
      run: ./gradlew graphUpdate
      continue-on-error: true
      shell: bash

    - name: Check Graphs
      id: graphs_verify
      run: git add -- "**/README.md" && git diff --cached --quiet --exit-code -- "**/README.md"
      shell: bash

    - name: Prevent updating graphs if this is a fork
      id: checkfork_graphs
      continue-on-error: false
      if: steps.graphs_verify.outcome == 'failure' && github.event.pull_request.head.repo.full_name != github.repository
      run: |
        echo "::error::Check Graphs failed, please update graphs with: ./gradlew graphUpdate" && exit 1
      shell: bash

    - name: Push new graphs if available
      if: steps.graphs_verify.outcome == 'failure' && github.event_name == 'pull_request'
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        file_pattern: '**/README.md'
        disable_globbing: true
        commit_message: "ðŸ¤– Updates graphs"

    - name: Run all local screenshot tests (Roborazzi)
      id: screenshotsverify
      continue-on-error: true
      run: ./gradlew verifyRoborazziDemoDebug
      shell: bash

    - name: Prevent pushing new screenshots if this is a fork
      id: checkfork_screenshots
      continue-on-error: false
      if: steps.screenshotsverify.outcome == 'failure' && github.event.pull_request.head.repo.full_name != github.repository
      run: |
        echo "::error::Screenshot tests failed, please create a PR in your fork first." 
        echo "Your fork's CI will take screenshots for your fork."
        exit 1
      shell: bash

    # Runs if previous job failed
    - name: Generate new screenshots if verification failed and it's a PR
      id: screenshotsrecord
      if: steps.screenshotsverify.outcome == 'failure' && github.event_name == 'pull_request'
      run: |
        ./gradlew recordRoborazziDemoDebug
      shell: bash

    - name: Push new screenshots if available
      uses: stefanzweifel/git-auto-commit-action@v5
      if: steps.screenshotsrecord.outcome == 'success'
      with:
        file_pattern: '*/*.png'
        disable_globbing: true
        commit_message: "ðŸ¤– Updates screenshots"

    # Run local tests after screenshot tests to avoid wrong UP-TO-DATE. TODO: Ignore screenshots.
    - name: Run local tests
      run: ./gradlew testDemoDebug :lint:test
      shell: bash

    - name: Build all build type and flavor permutations
      run: ./gradlew :app:assemble -PminifyWithR8=false
      shell: bash

    - name: Upload build outputs (APKs)
      uses: actions/upload-artifact@v4
      with:
        name: APKs
        path: '**/build/outputs/apk/**/*.apk'

    - name: Upload JVM local results (XML)
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: local-test-results
        path: '**/build/test-results/test*UnitTest/**.xml'

    - name: Upload screenshot results (PNG)
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: screenshot-test-results
        path: '**/build/outputs/roborazzi/*_compare.png'

    - name: Check lint
      run: ./gradlew :app:lintProdRelease :app-nia-catalog:lintRelease :lint:lint
      shell: bash

    - name: Upload lint reports (HTML)
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports
        path: '**/build/reports/lint-results-*.html'

    - name: Upload lint reports (SARIF) for app module
      if: ${{ !cancelled() && hashFiles('app/**/*.sarif') != '' }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './app/'
        category: app

    - name: Upload lint reports (SARIF) for app-nia-catalog module
      if: ${{ !cancelled() && hashFiles('app-nia-catalog/**/*.sarif') != '' }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './app-nia-catalog/'
        category: app-nia-catalog

    - name: Upload lint reports (SARIF) for lint module
      if: ${{ !cancelled() && hashFiles('lint/**/*.sarif') != '' }}
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: './lint/'
        category: lint

    - name: Check badging
      run: ./gradlew :app:checkProdReleaseBadging
      shell: bash
